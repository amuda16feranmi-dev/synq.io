<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Contacts</title>

<style>
body {
  font-family: Arial;
  background: #ece5dd;
  margin: 0;
}

.header {
  background: #075e54;
  color: white;
  padding: 15px;
  text-align: center;
}

.search-box {
  padding: 10px;
  background: #fff;
}

.search-box input {
  width: 100%;
  padding: 10px;
  border-radius: 20px;
  border: 1px solid #ccc;
}

.section-title {
  padding: 10px;
  font-weight: bold;
}

.contact {
  background: white;
  padding: 12px;
  margin: 8px;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.add-btn {
  background: #25d366;
  border: none;
  color: white;
  padding: 6px 10px;
  border-radius: 5px;
  cursor: pointer;
}

.saved {
  background: #ddd;
}
</style>
</head>

<body>

<div class="header">Contacts</div>

<div class="search-box">
  <input type="text" id="searchInput" placeholder="Search username">
</div>

<div class="section-title">Search Results</div>
<div id="searchResults"></div>

<div class="section-title">My Contacts</div>
<div id="myContacts"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCSo3we0rPWhMSgDz-gghQUcv5DxaM7cCs",
  authDomain: "synq-1a6fe.firebaseapp.com",
  projectId: "synq-1a6fe",
  storageBucket: "synq-1a6fe.firebasestorage.app",
  messagingSenderId: "991435331026",
  appId: "1:991435331026:web:94022c39f22a4f7ee9240b"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

let currentUserId = "";

/* Protect page */
auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "login.html";
  } else {
    currentUserId = user.uid;
    loadMyContacts();
  }
});

/* SEARCH USERS */
document.getElementById("searchInput").addEventListener("keyup", function () {
  const text = this.value.toLowerCase();
  const resultBox = document.getElementById("searchResults");
  resultBox.innerHTML = "";

  if (text === "") return;

  db.collection("users").get().then(snapshot => {
    snapshot.forEach(doc => {
      if (doc.id !== currentUserId) {
        const user = doc.data();
        if (user.username.toLowerCase().includes(text)) {
          const div = document.createElement("div");
          div.className = "contact";
          div.innerHTML = `
            <span>${user.username}</span>
            <button class="add-btn" onclick="addContact('${doc.id}', '${user.username}', '${user.email}')">Add</button>
          `;
          resultBox.appendChild(div);
        }
      }
    });
  });
});

/* ADD CONTACT */
function addContact(uid, username, email) {
  db.collection("users")
    .doc(currentUserId)
    .collection("contacts")
    .doc(uid)
    .set({
      uid: uid,
      username: username,
      email: email
    })
    .then(() => {
      alert("Contact added");
      loadMyContacts();
    });
}

/* LOAD SAVED CONTACTS */
function loadMyContacts() {
  const box = document.getElementById("myContacts");
  box.innerHTML = "";

  db.collection("users")
    .doc(currentUserId)
    .collection("contacts")
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        box.innerHTML = "No saved contacts";
        return;
      }

      snapshot.forEach(doc => {
        const c = doc.data();
        const div = document.createElement("div");
        div.className = "contact saved";
        div.innerHTML = `<span>${c.username}</span>`;
        box.appendChild(div);
      });
    });
}

/* FOOTER*/
function logout() {
  auth.signOut().then(() => {
    window.location.href = "login.html";
  });
}
</script>
</script>

</body>
</html>